<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCIS Image Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        img {
            max-width: 300px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üß™ ARCIS Image Loading Test</h1>

    <div id="api-test" class="test-section">
        <h2>üì° API Response Test</h2>
        <p>Testing API endpoint: <code>https://arcis-production.up.railway.app/api/detections/threats</code></p>
        <div id="api-result">Loading...</div>
    </div>

    <div id="image-test" class="test-section">
        <h2>üñºÔ∏è Image Loading Test</h2>
        <div id="image-result">Waiting for API response...</div>
    </div>

    <div id="frontend-simulation" class="test-section">
        <h2>üéØ Frontend Logic Simulation</h2>
        <div id="frontend-result">Waiting for API response...</div>
    </div>

    <script>
        const API_BASE_URL = 'https://arcis-production.up.railway.app/api';

        async function testAPI() {
            const resultDiv = document.getElementById('api-result');

            try {
                const response = await fetch(`${API_BASE_URL}/detections/threats`);
                const data = await response.json();

                console.log('API Response:', data);
                console.log('Data type:', typeof data);
                console.log('Is array:', Array.isArray(data));

                const threats = data.active_weapon_threats || [];
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ API Response Successful</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Data Type:</strong> ${typeof data}</p>
                        <p><strong>Threat Count:</strong> ${threats.length}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                return data;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå API Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                return null;
            }
        }

        async function testImageLoading(apiData) {
            const resultDiv = document.getElementById('image-result');

            console.log('testImageLoading - apiData:', apiData);

            const threats = apiData?.active_weapon_threats || [];
            console.log('testImageLoading - threats:', threats);

            if (!threats || threats.length === 0) {
                resultDiv.innerHTML = `<div class="error">‚ùå No threats data available
                    <br>Threats found: ${threats.length}
                </div>`;
                return;
            }

            let html = '<h3>üñºÔ∏è Image Loading Results</h3>';

            for (const threat of threats) {
                html += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">`;
                html += `<h4>Threat ID: ${threat.id}</h4>`;

                // Test Priority 1: Binary JPEG endpoint
                if (threat.has_binary_jpeg && threat.jpeg_endpoint) {
                    const fullUrl = threat.jpeg_endpoint.startsWith('http')
                        ? threat.jpeg_endpoint
                        : `${API_BASE_URL}${threat.jpeg_endpoint}`;

                    html += `
                        <div class="info">
                            <p><strong>Priority 1: Binary JPEG</strong></p>
                            <p>URL: <code>${fullUrl}</code></p>
                            <img src="${fullUrl}" alt="Detection Frame" 
                                 onload="this.nextElementSibling.innerHTML='‚úÖ Image loaded successfully!'" 
                                 onerror="this.nextElementSibling.innerHTML='‚ùå Image failed to load'">
                            <p>Loading status...</p>
                        </div>
                    `;
                } else {
                    html += '<p>‚è≠Ô∏è Priority 1: Binary JPEG not available</p>';
                }

                // Test Priority 2: File URL
                if (threat.frame_url) {
                    html += '<p>‚úÖ Priority 2: Frame URL available</p>';
                } else {
                    html += '<p>‚è≠Ô∏è Priority 2: Frame URL not available</p>';
                }

                // Test Priority 3: Base64 data
                if (threat.detection_frame_data) {
                    html += '<p>‚úÖ Priority 3: Base64 data available</p>';
                } else {
                    html += '<p>‚è≠Ô∏è Priority 3: Base64 data not available</p>';
                }

                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        async function simulateFrontendLogic(apiData) {
            const resultDiv = document.getElementById('frontend-result');

            console.log('simulateFrontendLogic - apiData:', apiData);

            const threats = apiData?.active_weapon_threats || [];
            console.log('simulateFrontendLogic - threats:', threats);

            if (!threats || threats.length === 0) {
                resultDiv.innerHTML = `<div class="error">‚ùå No threats data available
                    <br>Threats found: ${threats.length}
                </div>`;
                return;
            }

            let html = '<h3>üéØ Frontend Priority Logic Simulation</h3>';

            for (const threat of threats) {
                html += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">`;
                html += `<h4>Threat ID: ${threat.id}</h4>`;

                let selectedUrl = null;
                let selectedPriority = null;

                // Priority 1: Binary JPEG endpoint
                if (threat.has_binary_jpeg && threat.jpeg_endpoint) {
                    selectedUrl = threat.jpeg_endpoint.startsWith('http')
                        ? threat.jpeg_endpoint
                        : `${API_BASE_URL}${threat.jpeg_endpoint}`;
                    selectedPriority = 'Priority 1: Binary JPEG endpoint';
                }
                // Priority 2: File URL
                else if (threat.frame_url) {
                    selectedUrl = threat.frame_url.startsWith('http')
                        ? threat.frame_url
                        : `${API_BASE_URL}${threat.frame_url}`;
                    selectedPriority = 'Priority 2: File URL';
                }
                // Priority 3: Base64 data
                else if (threat.detection_frame_data) {
                    selectedUrl = threat.detection_frame_data.startsWith('data:')
                        ? threat.detection_frame_data
                        : `data:image/png;base64,${threat.detection_frame_data}`;
                    selectedPriority = 'Priority 3: Base64 data';
                }

                if (selectedUrl) {
                    html += `
                        <div class="success">
                            <p><strong>Selected:</strong> ${selectedPriority}</p>
                            <p><strong>URL:</strong> <code>${selectedUrl.substring(0, 100)}${selectedUrl.length > 100 ? '...' : ''}</code></p>
                            <p><strong>This is what the frontend should use</strong></p>
                        </div>
                    `;
                } else {
                    html += '<div class="error">‚ùå No image source available</div>';
                }

                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        // Run tests
        async function runTests() {
            console.log('üß™ Starting ARCIS Image Loading Tests...');

            const apiData = await testAPI();
            if (apiData) {
                await testImageLoading(apiData);
                await simulateFrontendLogic(apiData);
            }
        }

        // Start tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>

</html>